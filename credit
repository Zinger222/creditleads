<?php
// index.php
declare(strict_types=1);
mb_internal_encoding('UTF-8');

// === –ù–ê–°–¢–†–û–ô–ö–ò (–ü–û–°–¢–ê–í–ï–¢–ï –†–ï–ê–õ–ù–ò –°–¢–û–ô–ù–û–°–¢–ò –ò–õ–ò –ò–ó–ü–û–õ–ó–í–ê–ô–¢–ï ENV) ===
$BOT_TOKEN = getenv('8455295320:AAE14t6zInNQTypIbu-EhMiCov_CX3aoI_I') ?: '8455295320:AAE14t6zInNQTypIbu-EhMiCov_CX3aoI_I';
$CHAT_ID   = getenv('-1003347616327')   ?: '-8455295320';

// –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –∫—ä–º Telegram
function send_to_telegram(string $token, string $chatId, string $text): array {
    $url = "https://api.telegram.org/bot{$token}/sendMessage";
    $payload = [
        'chat_id'    => $chatId,
        'text'       => $text,
        'parse_mode' => 'HTML',
        'disable_web_page_preview' => true
    ];
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_POST           => true,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_HTTPHEADER     => ['Content-Type: application/json; charset=utf-8'],
        CURLOPT_POSTFIELDS     => json_encode($payload, JSON_UNESCAPED_UNICODE),
        CURLOPT_TIMEOUT        => 15,
    ]);
    $resp = curl_exec($ch);
    $err  = curl_error($ch);
    $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    return ['ok' => $err === '' && $code === 200 && json_decode($resp, true)['ok'] ?? false,
            'http_code' => $code, 'error' => $err, 'raw' => $resp];
}

$success = false;
$errorMsg = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // –õ–µ–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
    $name            = trim($_POST['name'] ?? '');
    $age             = trim($_POST['age'] ?? '');
    $job_status      = trim($_POST['job_status'] ?? '');
    $has_loans       = trim($_POST['has_loans'] ?? '');
    $total_loans     = trim($_POST['total_loans'] ?? '');
    $salary          = trim($_POST['salary'] ?? '');
    $monthly_payment = trim($_POST['monthly_payment'] ?? '');
    $fast_loans      = trim($_POST['fast_loans'] ?? '');
    $phone           = trim($_POST['phone'] ?? '');

    // –ü—Ä–æ–≤–µ—Ä–∫–∏
    if ($name === '' || $age === '' || $job_status === '' || $has_loans === '' ||
        $total_loans === '' || $salary === '' || $monthly_payment === '' ||
        $fast_loans === '' || $phone === '') {
        $errorMsg = '–ú–æ–ª—è, –ø–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞.';
    } elseif (!preg_match('/^\+?[0-9\s\-()]{7,}$/u', $phone)) {
        $errorMsg = '–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä.';
    } elseif (!is_numeric($age) || (int)$age < 18 || (int)$age > 100) {
        $errorMsg = '–í—ä–∑—Ä–∞—Å—Ç—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –º–µ–∂–¥—É 18 –∏ 100.';
    } elseif (!is_numeric($total_loans) || !is_numeric($salary) || !is_numeric($monthly_payment)) {
        $errorMsg = '–°—É–º–∏—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –±—ä–¥–∞—Ç —á–∏—Å–ª–∞.';
    } elseif (!$BOT_TOKEN || !$CHAT_ID || str_contains($BOT_TOKEN, 'YOUR_TELEGRAM_BOT_TOKEN_HERE')) {
        $errorMsg = '–ù–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω BOT_TOKEN/CHAT_ID.';
    } else {
        // –ò–∑–≥—Ä–∞–∂–¥–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ
        $message = "üì© <b>–ù–æ–≤–æ –∑–∞–ø–∏—Ç–≤–∞–Ω–µ –æ—Ç —Å–∞–π—Ç–∞ \"–ö—Ä–µ–¥–∏—Ç–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è\":</b>\n"
                 . "üë§ –ò–º–µ: " . htmlspecialchars($name, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8') . "\n"
                 . "üéÇ –í—ä–∑—Ä–∞—Å—Ç: " . (int)$age . "\n"
                 . "üíº –†–∞–±–æ—Ç–µ–Ω —Å—Ç–∞—Ç—É—Å: " . htmlspecialchars($job_status, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8') . "\n"
                 . "üí≥ –ò–º–∞ –∫—Ä–µ–¥–∏—Ç–∏: " . htmlspecialchars($has_loans, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8') . "\n"
                 . "üí∞ –û–±—â–∞ —Å—É–º–∞ –∫—Ä–µ–¥–∏—Ç–∏: " . number_format((float)$total_loans, 2, '.', ' ') . " –ª–≤\n"
                 . "üíµ –ó–∞–ø–ª–∞—Ç–∞: " . number_format((float)$salary, 2, '.', ' ') . " –ª–≤\n"
                 . "üìÜ –ú–µ—Å–µ—á–Ω–∞ –≤–Ω–æ—Å–∫–∞: " . number_format((float)$monthly_payment, 2, '.', ' ') . " –ª–≤\n"
                 . "‚ö° –ë—ä—Ä–∑–∏ –∑–∞–µ–º–∏: " . htmlspecialchars($fast_loans, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8') . "\n"
                 . "üìû –¢–µ–ª–µ—Ñ–æ–Ω: " . htmlspecialchars($phone, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');

        $result = send_to_telegram($BOT_TOKEN, $CHAT_ID, $message);
        if ($result['ok']) {
            $success = true;
            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ POST –∑–∞ –¥–∞ –Ω–µ —Å–µ –ø—Ä–µ–∑–∞—Ä–µ–∂–¥–∞ —Å—ä—Å —Å—Ç–∞—Ä–∏ –¥–∞–Ω–Ω–∏
            $_POST = [];
        } else {
            $errorMsg = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –∫—ä–º Telegram. –ö–æ–¥: ' . ($result['http_code'] ?? 'n/a');
        }
    }
}
?>
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö—Ä–µ–¥–∏—Ç–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: url('https://images.unsplash.com/photo-1567427017947-545c5f8d16ad?auto=format&fit=crop&w=1950&q=80') no-repeat center center/cover;
      color: #fff;
    }
    .overlay {
      background: rgba(0, 0, 0, 0.7);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
    }
    h1 { font-size: 2.5rem; margin-bottom: 10px; text-align: center; color: #ffdd57; }
    p { text-align: center; max-width: 600px; margin-bottom: 30px; color: #eee; }
    form {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 25px; border-radius: 15px; max-width: 500px; width: 100%;
      display: flex; flex-direction: column; gap: 15px;
    }
    label { font-weight: 600; }
    input, select {
      padding: 10px; border: none; border-radius: 8px; outline: none; font-size: 1rem;
    }
    button {
      background-color: #ffdd57; color: #000; font-weight: bold; padding: 12px;
      border: none; border-radius: 10px; cursor: pointer; transition: 0.3s;
    }
    button:hover { background-color: #ffc107; }
    .success {
      background: green; color: #fff; text-align: center; padding: 10px; border-radius: 10px; margin-top: 15px;
      display: <?php echo $success ? 'block' : 'none'; ?>;
    }
    .error {
      background: #b00020; color: #fff; text-align: center; padding: 10px; border-radius: 10px; margin-top: 15px;
      display: <?php echo $errorMsg ? 'block' : 'none'; ?>;
    }
  </style>
</head>
<body>
  <div class="overlay">
    <h1>üí∞ –ö—Ä–µ–¥–∏—Ç–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è</h1>
    <p>–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –∫—Ä–∞—Ç–∫–∏—è –≤—ä–ø—Ä–æ—Å–Ω–∏–∫ –∏ –Ω–∞—à –∫–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç —â–µ —Å–µ —Å–≤—ä—Ä–∂–µ —Å –≤–∞—Å, –∑–∞ –¥–∞ –≤–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –Ω–∞–π-–¥–æ–±—Ä–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –∑–∞ –∫—Ä–µ–¥–∏—Ç.</p>

    <form method="post" action="">
      <label>–ò–º–µ –∏ —Ñ–∞–º–∏–ª–∏—è:</label>
      <input type="text" name="name" required value="<?php echo htmlspecialchars($_POST['name'] ?? '', ENT_QUOTES); ?>"/>

      <label>–ù–∞ –∫–æ–ª–∫–æ –≥–æ–¥–∏–Ω–∏ —Å—Ç–µ:</label>
      <input type="number" name="age" required value="<?php echo htmlspecialchars($_POST['age'] ?? '', ENT_QUOTES); ?>"/>

      <label>–†–∞–±–æ—Ç–µ–Ω —Å—Ç–∞—Ç—É—Å:</label>
      <select name="job_status" required>
        <?php
          $opts = ['–†–∞–±–æ—Ç—è','–ë–µ–∑—Ä–∞–±–æ—Ç–µ–Ω','–°–∞–º–æ–Ω–∞–µ—Ç','–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä'];
          $cur  = $_POST['job_status'] ?? '';
          foreach ($opts as $o) {
              $sel = $cur === $o ? 'selected' : '';
              echo "<option value=\"{$o}\" {$sel}>{$o}</option>";
          }
        ?>
      </select>

      <label>–ò–º–∞—Ç–µ –ª–∏ –∫—Ä–µ–¥–∏—Ç–∏:</label>
      <select name="has_loans" required>
        <?php
          $opts = ['–î–∞','–ù–µ'];
          $cur  = $_POST['has_loans'] ?? '';
          foreach ($opts as $o) {
              $sel = $cur === $o ? 'selected' : '';
              echo "<option value=\"{$o}\" {$sel}>{$o}</option>";
          }
        ?>
      </select>

      <label>–û–±—â–∞ —Å—É–º–∞ –Ω–∞ –∫—Ä–µ–¥–∏—Ç–∏—Ç–µ (–ª–≤):</label>
      <input type="number" step="0.01" name="total_loans" required value="<?php echo htmlspecialchars($_POST['total_loans'] ?? '', ENT_QUOTES); ?>"/>

      <label>–í–∞—à–∞—Ç–∞ –∑–∞–ø–ª–∞—Ç–∞ (–ª–≤):</label>
      <input type="number" step="0.01" name="salary" required value="<?php echo htmlspecialchars($_POST['salary'] ?? '', ENT_QUOTES); ?>"/>

      <label>–ú–µ—Å–µ—á–Ω–∞ –≤–Ω–æ—Å–∫–∞ –ø–æ –∫—Ä–µ–¥–∏—Ç–∏ (–ª–≤):</label>
      <input type="number" step="0.01" name="monthly_payment" required value="<?php echo htmlspecialchars($_POST['monthly_payment'] ?? '', ENT_QUOTES); ?>"/>

      <label>–ò–º–∞—Ç–µ –ª–∏ –±—ä—Ä–∑–∏ –∑–∞–µ–º–∏:</label>
      <select name="fast_loans" required>
        <?php
          $opts = ['–î–∞','–ù–µ'];
          $cur  = $_POST['fast_loans'] ?? '';
          foreach ($opts as $o) {
              $sel = $cur === $o ? 'selected' : '';
              echo "<option value=\"{$o}\" {$sel}>{$o}</option>";
          }
        ?>
      </select>

      <label>–¢–µ–ª–µ—Ñ–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä:</label>
      <input type="tel" name="phone" required value="<?php echo htmlspecialchars($_POST['phone'] ?? '', ENT_QUOTES); ?>"/>

      <button type="submit">–ò–∑–ø—Ä–∞—Ç–∏</button>
    </form>

    <div class="success">‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–∑–ø—Ä–∞—Ç–µ–Ω–æ! –ù–∞—à –∫–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç —â–µ —Å–µ —Å–≤—ä—Ä–∂–µ —Å –≤–∞—Å.</div>
    <div class="error">‚ùå <?php echo htmlspecialchars($errorMsg, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8'); ?></div>
  </div>
</body>
</html>
